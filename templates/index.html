<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analizador de Titulares</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <link href="https://fonts.cdnfonts.com/css/product-sans" rel="stylesheet">
</head>
<body>
  <main class="container">
    <!--Task 1: here create your title and subtitle-->
    <h1>Identificador de titulares</h1>
    <p class="subtitle">Identifica la veracidad de los titulares que leas</p>

    <section class="card">
      <!--we use sections as containers to organize code better, we'll create the following tasks inside sections-->
      <!--Task 2: create your headline-->
      <label for="headline">Tu titular</label>
      <div class="chatBar">
        <!--Task 2: add the text area for the user's input-->
        <textarea id="headline" placeholder="Escribe tu titular. Ejemplo: Un gato se come a su dueño." rows="1"></textarea>
        <div class="row">
          <!--divs are a different type of container (like a smaller one), we'll do the buttons here-->
          <!--Task 3: create your buttons here-->
          <button id="clearBtn" class="secondary"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg></button>

          <button id="analyzeBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024">
  <g>
    <path d="M 678.13 745.60 C555.90,623.46 558.68,626.06 554.93,630.58 C553.15,632.73 543.35,639.54 539.00,641.65 C538.17,642.05 535.25,643.78 532.50,645.48 C522.99,651.39 502.57,660.41 491.84,663.45 C489.28,664.18 486.65,665.10 486.01,665.49 C484.59,666.37 476.50,668.29 460.00,671.67 C448.35,674.06 445.50,674.24 418.00,674.33 C387.19,674.43 380.79,673.78 358.50,668.33 C299.38,653.85 247.00,615.50 211.67,560.82 C204.13,549.15 194.78,532.17 192.64,526.28 C191.89,524.20 190.13,519.35 188.74,515.50 C183.70,501.59 179.53,484.52 177.99,471.50 C177.41,466.55 176.52,460.48 176.01,458.00 C174.82,452.20 174.77,416.32 175.94,408.50 C179.43,385.16 180.37,379.60 182.06,372.50 C191.93,331.10 214.11,292.07 246.00,260.01 C266.92,238.98 294.11,220.10 319.23,209.15 C338.07,200.93 346.81,198.16 366.00,194.35 C370.12,193.53 375.52,192.44 378.00,191.94 C387.59,189.97 401.28,189.02 420.09,189.01 C438.33,189.00 445.00,189.59 464.00,192.88 C475.87,194.93 494.70,200.29 507.04,205.13 C519.91,210.17 525.00,213.06 525.00,215.33 C525.00,217.44 470.70,270.73 467.89,271.37 C466.45,271.70 461.27,271.11 456.39,270.05 C442.11,266.97 428.58,265.82 412.00,266.28 C396.66,266.71 385.02,267.96 377.75,269.96 C375.69,270.53 372.09,271.50 369.75,272.12 C360.28,274.62 341.93,282.32 336.32,286.15 C334.02,287.72 331.91,289.00 331.64,289.00 C330.47,289.00 319.62,297.00 311.86,303.59 C304.28,310.02 285.00,329.94 285.00,331.33 C285.00,331.65 282.73,334.94 279.96,338.65 C271.05,350.57 259.54,376.03 257.42,388.50 C257.04,390.70 256.32,393.31 255.80,394.31 C255.29,395.30 254.21,403.85 253.40,413.31 C251.53,435.37 252.77,459.96 256.52,474.78 C257.87,480.13 259.46,486.52 260.04,489.00 C261.44,494.88 271.04,514.61 276.84,523.50 C283.21,533.26 293.26,545.08 303.20,554.50 C317.18,567.74 326.29,574.24 342.14,582.28 C357.76,590.20 365.04,592.80 380.50,595.96 C383.80,596.64 387.62,597.64 389.00,598.19 C393.12,599.84 429.71,600.48 438.68,599.06 C481.18,592.31 503.62,582.20 533.79,556.19 C540.19,550.66 551.02,537.81 559.31,525.86 C563.69,519.57 574.00,499.84 574.00,497.77 C574.00,497.24 574.62,495.38 575.38,493.65 C579.07,485.20 582.31,473.04 583.92,461.58 C585.47,450.60 582.82,451.25 623.30,451.78 C665.16,452.32 662.02,451.02 658.84,466.50 C657.72,472.00 656.45,478.52 656.04,481.00 C655.19,486.06 651.61,499.44 649.47,505.50 C648.70,507.70 647.36,511.52 646.49,514.00 C645.62,516.47 643.63,521.20 642.06,524.50 C640.50,527.80 638.20,532.75 636.94,535.50 C635.02,539.73 629.22,550.15 624.71,557.46 C623.68,559.14 621.30,562.44 614.27,571.92 C613.19,573.37 627.93,588.48 730.02,690.53 C811.07,771.55 847.00,808.12 847.00,809.57 C847.00,810.99 838.98,819.65 822.49,836.05 C809.01,849.46 797.26,860.83 796.40,861.32 C795.15,862.01 770.28,837.68 678.13,745.60 ZM 715.04 502.07 C714.47,501.00 714.00,497.44 714.00,494.16 C714.00,488.13 708.58,464.37 705.73,457.88 C704.91,456.02 703.44,452.25 702.45,449.50 C700.58,444.27 693.55,429.32 689.79,422.55 C679.85,404.66 652.61,373.46 639.99,365.49 C637.76,364.08 634.26,361.45 632.21,359.64 C615.05,344.46 573.72,327.46 545.50,323.98 C530.15,322.09 531.14,320.14 549.00,317.03 C581.19,311.43 612.12,297.56 639.38,276.51 C667.46,254.83 691.99,221.22 704.02,187.95 C709.23,173.55 714.00,153.46 714.00,145.94 C714.00,133.83 717.79,129.61 719.26,140.08 C725.00,180.88 736.08,208.39 759.13,239.07 C769.83,253.31 792.37,275.17 805.33,283.87 C832.09,301.82 860.27,313.09 889.35,317.45 C899.88,319.03 901.00,319.42 901.00,321.49 C901.00,323.43 898.12,324.13 886.59,324.99 C876.96,325.71 866.18,328.21 852.00,333.04 C841.74,336.53 825.45,344.02 819.50,347.98 C817.30,349.44 812.12,352.84 808.00,355.53 C788.70,368.13 766.58,390.19 752.22,411.17 C746.21,419.95 744.27,423.35 738.87,434.50 C728.80,455.29 724.93,466.99 721.48,487.00 C720.10,494.98 718.77,502.06 718.52,502.75 C717.85,504.59 716.22,504.27 715.04,502.07 Z" fill="rgba(255,255,255,1)"/>
  </g>
</svg>

</button>
          
        </div>
      </div>

      <p id="status" class="status"></p>
    </section>

    <section id="result" class="card hidden">
      <!--note that the class of this card starts as hidden, this changes in the script whenever we get the data from back end-->
      <!--i left a little note when that happens-->
      <!--now that you learned about modularity you'll create the everything inside this section-->
      <!--Task 4: create all you need in here-->
      <div class="resultTop">Resultados</div>
        <div>
          <!--here the label-->
          <h2 id="label" class="label">—</h2>
          <!--here your score line (remember what type we use for text and dont forget to give it class "small")-->
          <p class="small">Puntuación: <span id="score">0</span>/100</p>
        </div>
        <div class="barWrap">
          <!--here your bar-->
          <div class="barWrap"><div class="bar" id="bar"></div></div>
        </div>
      </div>
      

      <!--add a subtitle for the reasons (i'd use h3 as we already used h2)-->
      <h3>¿Por qué?</h3>
      <!--here your list of reasons (check the types!!)-->
      <ul id="reasons"></ul>

      <!--add a subtitle for the metrics (i'd use h3 to be consistent)-->
      <h3>Categorías</h3>
      <!--here your metric container... this is a blackbox we will discuss about it-->
      <div class="metrics" id="metrics"></div>

      <!--add a subtitle for the tips (i'd use h3 to be consistent)-->
      <h3>Algunos consejos</h3>
      <!--here your numbered list of tips (check the types!!)-->
      <ol id="tips"></ol>
    </section>
  </main>

  <!--let's try to understand this part as much as possible but you shouldn't modify anything here-->
  <script>
    const API_URL = "";

    const headlineEl = document.getElementById("headline");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const clearBtn = document.getElementById("clearBtn");
    const statusEl = document.getElementById("status");

    const resultEl = document.getElementById("result");
    const labelEl = document.getElementById("label");
    const scoreEl = document.getElementById("score");
    const barEl = document.getElementById("bar");
    const reasonsEl = document.getElementById("reasons");
    const metricsEl = document.getElementById("metrics");
    const tipsEl = document.getElementById("tips");

    const METRIC_LABELS = {
      caps_ratio: "Porcentaje de Mayúsculas",
      exclamation_count: "Signos de Exclamación",
      alarm_count: "Palabras Alarmantes",
      absolute_count: "Palabras Absolutistas",
      clickbait_hits: "Frases Sensacionalistas",
      hiding_count: "Palabras Sustitutas",
      intensifier_count: "Intensificadores",
      suspicious_quotes: "Comillas Sospechosas",
      length_words: "Cantidad de Palabras",
    };
    function setStatus(msg, isError=false) {
      statusEl.textContent = msg;
      statusEl.classList.toggle("error", isError);
    }

    function labelClass(label) {
      if (label === "BAJO") return "green";
      if (label === "MEDIO") return "yellow";
      return "red";
    }

    // Compute the SAME points logic as the backend (so weights are meaningful)
    function pointsBreakdown(data) {
      const m = data.metrics || {};
      const caps = Number(m.caps_ratio ?? 0);
      const ex = Number(m.exclamation_count ?? 0);
      const alarm = Number(m.alarm_count ?? 0);
      const abs = Number(m.absolute_count ?? 0);
      const click = Number(m.clickbait_hits ?? 0);
      const hide = Number(m.hiding_count ?? 0);
      const intens = Number(m.intensifier_count ?? 0);
      const quotes = Number(m.suspicious_quotes ?? 0);
      const lenWords = Number(m.length_words ?? 0);

      const points = {};

      // caps
      if (caps > 0.25) points.caps_ratio = 100*caps;
      else if (caps > 0.15) points.caps_ratio = 15;
      else points.caps_ratio = 0;

      // exclamations
      points.exclamation_count = ex > 0 ? Math.max(20, 4 * ex) : 0;

      // alarm words
      points.alarm_count = alarm > 0 ? Math.max(30, 20 * alarm) : 0;

      // absolutes
      points.absolute_count = abs > 0 ? Math.max(20, 15 * abs) : 0;

      // clickbait
      points.clickbait_hits = click > 0 ? (30 * click) : 0;

      // hiding words
      points.hiding_count = hide > 0 ? Math.max(10, 4 * hide) : 0;

      // intensifiers
      points.intensifier_count = intens > 0 ? Math.max(15, 6 * intens) : 0;

      // suspicious quotes
      points.suspicious_quotes = quotes > 0 ? Math.max(15, 8 * quotes) : 0;

      const score_length = Math.round(Math.abs(lenWords - 8.5));
      points.length_words = (score_length > 4) ? (5 * score_length) : 0;
          return points;
        }

    // Weight = contribution to final score (share of score)
    function weightPercent(pointsForMetric, totalScore) {
      if (!totalScore || totalScore <= 0) return 0;
      return Math.max(0, Math.min(100, Math.round((pointsForMetric / totalScore) * 100)));
    }

    function render(data) {
      // make visible first so animations work
      resultEl.classList.remove("hidden");

      labelEl.textContent = data.label;
      labelEl.className = "label " + labelClass(data.label);

      scoreEl.textContent = data.score;

      // Main bar animation
      barEl.className = "bar " + labelClass(data.label);
      barEl.dataset.score = data.score;

      barEl.style.width = "0%";
      void barEl.offsetWidth;
      barEl.style.width = data.score + "%";

      barEl.classList.remove("anim");
      void barEl.offsetWidth;
      barEl.classList.add("anim");

      // Reasons
      reasonsEl.innerHTML = "";
      data.reasons.forEach(r => {
        const li = document.createElement("li");
        li.textContent = r;
        reasonsEl.appendChild(li);
      });

      // Metrics with circular “weight rings”
      const pts = pointsBreakdown(data);
      const total = Number(data.score ?? 0);

      metricsEl.innerHTML = "";
      Object.entries(data.metrics).forEach(([k, v]) => {
        const label = METRIC_LABELS[k] ?? k;
        const p = Number(pts[k] ?? 0);
        const pct = weightPercent(p, total); // % of total score

        const div = document.createElement("div");
        div.className = "metric";

        // Keep .k and .v classes (don’t break CSS expectations)
        div.innerHTML = `
          <span class="k">${label}</span>
          <div class="vwrap">
            <div class="ring ${labelClass(data.label)}" style="--target:${pct};" title="Contribution: +${p} points (${pct}% of score)">
              <div class="ring__inner">
                <span class="v">${v}</span>
              </div>
            </div>
            <span class="pts">${p > 0 ? `+${p}` : ""}</span>
          </div>
        `;

        // trigger ring animation every render
        const ring = div.querySelector(".ring");
        ring.classList.remove("anim");
        void ring.offsetWidth;
        ring.classList.add("anim");

        metricsEl.appendChild(div);
      });

      // Tips
      tipsEl.innerHTML = "";
      (data.tips || []).forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        tipsEl.appendChild(li);
      });
    }

    analyzeBtn.addEventListener("click", async () => {
      const text = headlineEl.value.trim();
      if (!text) {
        setStatus("Pega un titular primero.", true);
        resultEl.classList.add("hidden");
        return;
      }

      setStatus("Analizando...");
      analyzeBtn.disabled = true;

      try {
        const res = await fetch("/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });

        const data = await res.json();
        if (!res.ok) {
          setStatus(data.error || "Error del servidor.", true);
          resultEl.classList.add("hidden");
          return;
        }

        setStatus("");
        render(data);
      } catch (e) {
        setStatus("No pude conectar con el backend. ¿Está corriendo Flask en 127.0.0.1:5000?", true);
        resultEl.classList.add("hidden");
      } finally {
        analyzeBtn.disabled = false;
      }
    });

    clearBtn.addEventListener("click", () => {
      headlineEl.value = "";
      resultEl.classList.add("hidden");
      setStatus("");

      barEl.style.width = "0%";
      barEl.dataset.score = "";
      barEl.className = "bar";
    });

    headlineEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        analyzeBtn.click();
      }
    });
  </script>
</body>
</html>


